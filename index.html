<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TWoW Craft Calc</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: monospace; background: #12121f; color: #ccc; padding: 20px; }
  h1 { color: #a855f7; margin-bottom: 16px; font-size: 1.2em; letter-spacing: 0.05em; }

  /* Drop zone */
  .drop-zone {
    border: 2px dashed #2a2a40; padding: 20px; text-align: center;
    color: #555; font-size: 0.85em; margin-bottom: 16px; max-width: 700px;
    transition: all 0.2s; cursor: pointer; position: relative;
  }
  .drop-zone:hover, .drop-zone.drag-over { border-color: #a855f7; color: #a855f7; }
  .drop-zone input[type="file"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer;
  }
  .drop-status { margin-top: 8px; font-size: 0.78em; }
  .drop-status.ok { color: #4ade80; }
  .drop-status.err { color: #f87171; }

  .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
  .controls select {
    background: #1c1c30; border: 1px solid #2a2a40; color: #ccc;
    padding: 6px 10px; font-family: monospace; font-size: 0.85em;
  }
  .controls select:focus { border-color: #a855f7; outline: none; }
  .controls label { color: #666; font-size: 0.8em; }
  .controls .ts { color: #555; font-size: 0.75em; }

  .prof-tabs { display: flex; flex-wrap: wrap; gap: 2px; margin-bottom: 16px; }
  .prof-tab {
    background: #1c1c30; border: 1px solid #2a2a40; color: #666; padding: 6px 14px;
    cursor: pointer; font-family: monospace; font-size: 0.8em; text-transform: uppercase;
    letter-spacing: 0.05em; transition: all 0.15s;
  }
  .prof-tab:hover { color: #aaa; border-color: #444; }
  .prof-tab.active { background: #2a2a40; color: #a855f7; border-color: #a855f7; }

  .recipe-list { display: flex; flex-direction: column; gap: 2px; max-width: 700px; }

  .recipe-row {
    display: grid; grid-template-columns: 1fr auto auto auto;
    gap: 12px; align-items: center; padding: 8px 14px;
    background: #1c1c30; border: 1px solid #2a2a40; cursor: pointer;
    font-size: 0.88em; transition: border-color 0.15s;
  }
  .recipe-row:hover { border-color: #a855f7; }
  .recipe-row .r-name { color: #ddd; }
  .recipe-row .r-cost { color: #888; font-size: 0.85em; white-space: nowrap; }
  .recipe-row .r-sell { color: #888; font-size: 0.85em; white-space: nowrap; }
  .recipe-row .r-profit { font-weight: bold; font-size: 0.85em; white-space: nowrap; }
  .recipe-row .r-profit.pos { color: #4ade80; }
  .recipe-row .r-profit.neg { color: #f87171; }
  .recipe-row .r-profit.unknown { color: #555; }

  .recipe-detail {
    display: none; background: #161628; border: 1px solid #2a2a40;
    border-top: none; padding: 12px 16px; max-width: 700px;
  }
  .recipe-detail.open { display: block; }

  .reagent {
    display: grid; grid-template-columns: 40px 1fr auto;
    align-items: center; gap: 8px; padding: 4px 0;
    border-bottom: 1px solid #1e1e32;
  }
  .reagent:last-child { border-bottom: none; }
  .reagent .r-qty { color: #555; font-size: 0.85em; }
  .reagent .r-rname { color: #bbb; font-size: 0.88em; }
  .reagent .r-price { font-size: 0.85em; white-space: nowrap; }
  .reagent .r-price.has-price { color: #888; }
  .reagent .r-price.no-price { color: #f87171; font-style: italic; }

  .sub-reagents {
    margin: 2px 0 6px 40px; border-left: 2px solid #2a2a40; padding-left: 10px;
  }
  .sub-label { font-size: 0.75em; color: #555; padding: 2px 0; display: flex; align-items: center; gap: 6px; }
  .check { color: #4ade80; font-size: 0.8em; }

  .detail-footer { margin-top: 10px; padding-top: 8px; border-top: 1px solid #2a2a40; }
  .detail-footer .footer-row { display: flex; gap: 10px; font-size: 0.85em; padding: 2px 0; }
  .detail-footer .fl { color: #555; min-width: 80px; }
  .detail-footer .fv { font-weight: bold; }

  .cur-g { color: #fbbf24; }
  .cur-s { color: #94a3b8; }
  .cur-c { color: #92400e; }

  .empty-msg { color: #555; font-size: 0.85em; padding: 20px 0; max-width: 700px; }
</style>
</head>
<body>
<h1>TWoW Profession Profit Calc</h1>

<div class="drop-zone" id="drop-zone">
  Drop your <b>aux-addon.lua</b> here or click to browse
  <input type="file" id="file-input" accept=".lua">
  <div style="margin-top:10px;font-size:0.75em;color:#444;">
    Usually found at: <code id="path-hint" style="color:#666;cursor:pointer;background:#1c1c30;padding:2px 6px;border:1px solid #2a2a40;" title="Click to copy">C:\Games\TurtleWoW\WTF\Account\&lt;ACCOUNT&gt;\SavedVariables\aux-addon.lua</code>
    <span id="copy-msg" style="color:#4ade80;margin-left:8px;display:none;">copied!</span>
  </div>
  <div class="drop-status" id="drop-status"></div>
</div>

<div class="controls" id="controls" style="display:none">
  <label>Faction:</label>
  <select id="faction-select"></select>
  <span class="ts" id="price-ts"></span>
</div>

<div class="prof-tabs" id="prof-tabs"></div>
<div id="recipe-container"></div>

<script>
let RECIPES = {}, ITEMS = {}, PRICES = {};
let currentFaction = '', currentProf = '';
let recipeByResult = {};
let recipesLoaded = false;

async function init() {
  const res = await fetch('recipes.json');
  if (!res.ok) { console.error('Failed to load recipes.json'); return; }
  const data = await res.json();
  RECIPES = data.professions;
  ITEMS = data.items;

  for (const prof of Object.values(RECIPES)) {
    for (const r of prof.recipes) {
      if (r.resultId) recipeByResult[r.resultId] = r;
    }
  }
  recipesLoaded = true;

  buildProfTabs();

  const saved = localStorage.getItem('twow-aux-prices');
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      PRICES = parsed.prices;
      onPricesLoaded(parsed.timestamp);
    } catch (e) { console.error('Failed to load saved prices', e); }
  }
}

// --- Drag & drop / file upload ---

function setupDropZone() {
  const zone = document.getElementById('drop-zone');
  const input = document.getElementById('file-input');

  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
  });
  input.addEventListener('change', () => { if (input.files.length) handleFile(input.files[0]); });
}

function handleFile(file) {
  const status = document.getElementById('drop-status');
  status.textContent = 'Parsing...';
  status.className = 'drop-status';

  const reader = new FileReader();
  reader.onload = () => {
    try {
      PRICES = parseAuxLua(reader.result);
      const ts = new Date().toISOString();
      localStorage.setItem('twow-aux-prices', JSON.stringify({ prices: PRICES, timestamp: ts }));
      onPricesLoaded(ts);
      const nonEmpty = Object.values(PRICES).filter(f => Object.keys(f).length > 0);
      const totalItems = nonEmpty.reduce((sum, f) => sum + Object.keys(f).length, 0);
      status.textContent = `Loaded ${totalItems} items from ${nonEmpty.length} faction(s)`;
      status.className = 'drop-status ok';
    } catch (e) {
      console.error(e);
      status.textContent = 'Error parsing file: ' + e.message;
      status.className = 'drop-status err';
    }
  };
  reader.readAsText(file);
}

// --- Lua parser (aux-addon.lua -> prices by faction) ---

function parseAuxLua(text) {
  const result = {};
  const factionIdx = text.indexOf('["faction"]');
  if (factionIdx === -1) throw new Error('No faction data found');

  const realmIdx = text.indexOf('["realm"]', factionIdx);
  const factionBlock = text.substring(factionIdx, realmIdx > 0 ? realmIdx : undefined);

  const factionRe = /\["([^"]+)\|([^"]+)"\]\s*=\s*\{/g;
  let fm;
  while ((fm = factionRe.exec(factionBlock)) !== null) {
    const key = fm[1] + '|' + fm[2];
    const historyStart = factionBlock.indexOf('["history"]', fm.index);
    if (historyStart === -1) continue;

    const braceStart = factionBlock.indexOf('{', historyStart + 11);
    if (braceStart === -1) continue;

    let depth = 1, end = braceStart + 1;
    for (; end < factionBlock.length && depth > 0; end++) {
      if (factionBlock[end] === '{') depth++;
      else if (factionBlock[end] === '}') depth--;
    }
    const histBlock = factionBlock.substring(braceStart + 1, end - 1);

    const prices = {};
    const entryRe = /\["(\d+):(\d+)"\]\s*=\s*"([^"]*)"/g;
    let em;
    while ((em = entryRe.exec(histBlock)) !== null) {
      const itemId = parseInt(em[1]);
      const suffixId = parseInt(em[2]);
      if (suffixId !== 0) continue;

      const parts = em[3].split('#');
      if (parts.length < 2) continue;

      let minBuyout = parts[1] ? Math.round(parseFloat(parts[1])) : null;
      if (minBuyout === 0) minBuyout = null;

      let dataPoints = [];
      if (parts.length > 2 && parts[2]) {
        for (const dp of parts[2].split(';')) {
          const [v, t] = dp.split('@');
          if (v && t) dataPoints.push({ value: Math.round(parseFloat(v)), time: parseInt(t) });
        }
      }

      let marketValue = minBuyout;
      if (dataPoints.length > 0) {
        let totalWeight = 0;
        const weighted = [];
        const refTime = dataPoints[0].time;
        for (const dp of dataPoints) {
          const w = Math.pow(0.99, Math.round((refTime - dp.time) / 86400));
          totalWeight += w;
          weighted.push({ value: dp.value, weight: w });
        }
        if (totalWeight > 0) {
          for (const w of weighted) w.weight /= totalWeight;
          weighted.sort((a, b) => a.value - b.value);
          let cum = 0;
          for (const w of weighted) {
            cum += w.weight;
            if (cum >= 0.5) { if (!marketValue) marketValue = w.value; break; }
          }
        }
      }

      if (marketValue) prices[itemId] = { minBuyout, marketValue };
    }
    result[key] = prices;
  }
  return result;
}

// --- UI rendering ---

function onPricesLoaded(timestamp) {
  const controls = document.getElementById('controls');
  controls.style.display = 'flex';

  const factionSel = document.getElementById('faction-select');
  factionSel.innerHTML = '';
  const factions = Object.keys(PRICES).filter(k => Object.keys(PRICES[k]).length > 0);
  factions.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f; opt.textContent = f;
    factionSel.appendChild(opt);
  });

  if (factions.length && !factions.includes(currentFaction)) {
    currentFaction = factions[0];
  }
  factionSel.value = currentFaction;
  factionSel.onchange = () => { currentFaction = factionSel.value; renderProf(); };

  if (timestamp) {
    const d = new Date(timestamp);
    document.getElementById('price-ts').textContent = 'Updated: ' + d.toLocaleString();
  }

  renderProf();
}

function buildProfTabs() {
  const tabsEl = document.getElementById('prof-tabs');
  tabsEl.innerHTML = '';
  const profKeys = Object.keys(RECIPES);
  profKeys.forEach(key => {
    const tab = document.createElement('div');
    tab.className = 'prof-tab';
    tab.dataset.prof = key;
    tab.textContent = RECIPES[key].name;
    tab.onclick = () => {
      currentProf = key;
      tabsEl.querySelectorAll('.prof-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderProf();
    };
    tabsEl.appendChild(tab);
  });
  if (profKeys.length) {
    currentProf = profKeys[0];
    tabsEl.firstChild.classList.add('active');
  }
}

function getPrice(itemId) {
  const fp = PRICES[currentFaction];
  if (!fp) return null;
  const p = fp[String(itemId)] || fp[itemId];
  return p ? (p.marketValue ?? p.minBuyout) : null;
}

function formatCopper(val) {
  if (val === null || val === undefined) return '<span class="cur-s">—</span>';
  const neg = val < 0; val = Math.abs(Math.round(val));
  const g = Math.floor(val / 10000), s = Math.floor((val % 10000) / 100), c = val % 100;
  let str = neg ? '<span style="color:#f87171">-</span>' : '';
  if (g > 0) str += `<span class="cur-g">${g}g</span> `;
  str += `<span class="cur-s">${s}s</span> <span class="cur-c">${c}c</span>`;
  return str;
}

function formatCopperCompact(val) {
  if (val === null || val === undefined) return '—';
  const neg = val < 0; val = Math.abs(Math.round(val));
  const g = Math.floor(val / 10000), s = Math.floor((val % 10000) / 100), c = val % 100;
  let str = neg ? '-' : '';
  if (g > 0) str += g + 'g ';
  str += s + 's ' + c + 'c';
  return str;
}

function calcCraftCost(recipe, visited = new Set()) {
  if (visited.has(recipe.spellId)) return null;
  visited.add(recipe.spellId);

  let total = 0;
  for (const r of recipe.reagents) {
    const subRecipe = recipeByResult[r.itemId];
    const buyPrice = getPrice(r.itemId);

    if (subRecipe && !visited.has(subRecipe.spellId)) {
      const craftPrice = calcCraftCost(subRecipe, new Set(visited));
      if (buyPrice !== null && craftPrice !== null) {
        total += Math.min(buyPrice, craftPrice) * r.qty;
      } else if (buyPrice !== null) {
        total += buyPrice * r.qty;
      } else if (craftPrice !== null) {
        total += craftPrice * r.qty;
      } else {
        return null;
      }
    } else {
      if (buyPrice !== null) {
        total += buyPrice * r.qty;
      } else {
        return null;
      }
    }
  }
  return total;
}

function renderProf() {
  const container = document.getElementById('recipe-container');
  container.innerHTML = '';

  if (!Object.keys(PRICES).length) {
    container.innerHTML = '<div class="empty-msg">Drop your aux-addon.lua above to load AH prices</div>';
    return;
  }

  const prof = RECIPES[currentProf];
  if (!prof) return;

  const list = document.createElement('div');
  list.className = 'recipe-list';

  const enriched = prof.recipes.map(recipe => {
    const craftCost = calcCraftCost(recipe);
    const sellPrice = recipe.resultId ? getPrice(recipe.resultId) : null;
    const profit = (craftCost !== null && sellPrice !== null) ? sellPrice - craftCost : null;
    return { recipe, craftCost, sellPrice, profit };
  });

  enriched.sort((a, b) => {
    if (a.profit !== null && b.profit !== null) return b.profit - a.profit;
    if (a.profit !== null) return -1;
    if (b.profit !== null) return 1;
    return 0;
  });

  enriched.forEach(({ recipe, craftCost, sellPrice, profit }) => {
    const row = document.createElement('div');
    row.className = 'recipe-row';
    row.innerHTML = `<span class="r-name">${recipe.name}</span>`
      + `<span class="r-cost">${formatCopper(craftCost)}</span>`
      + `<span class="r-sell">${formatCopper(sellPrice)}</span>`
      + `<span class="r-profit ${profit !== null ? (profit >= 0 ? 'pos' : 'neg') : 'unknown'}">${profit !== null ? formatCopperCompact(profit) : '—'}</span>`;

    const detail = document.createElement('div');
    detail.className = 'recipe-detail';

    let detailBuilt = false;
    row.onclick = () => {
      if (!detailBuilt) { detail.innerHTML = buildDetail(recipe); detailBuilt = true; }
      row.classList.toggle('open');
      detail.classList.toggle('open');
    };

    list.appendChild(row);
    list.appendChild(detail);
  });

  container.appendChild(list);
}

function buildDetail(recipe) {
  let html = '';

  recipe.reagents.forEach(r => {
    const name = ITEMS[String(r.itemId)]?.name || `Item #${r.itemId}`;
    const price = getPrice(r.itemId);
    const subRecipe = recipeByResult[r.itemId];

    html += `<div class="reagent">`;
    html += `<span class="r-qty">${r.qty}x</span>`;
    html += `<span class="r-rname">${name}</span>`;
    html += price !== null
      ? `<span class="r-price has-price">${formatCopper(price)} ea</span>`
      : `<span class="r-price no-price">no data</span>`;
    html += `</div>`;

    if (subRecipe) {
      const buyCost = price !== null ? price * r.qty : null;
      const craftCost = calcCraftCost(subRecipe);
      const totalCraft = craftCost !== null ? craftCost * r.qty : null;
      const cheaper = (buyCost !== null && totalCraft !== null)
        ? (buyCost <= totalCraft ? 'buy' : 'craft')
        : (buyCost !== null ? 'buy' : (totalCraft !== null ? 'craft' : null));

      html += `<div class="sub-reagents">`;
      html += `<div class="sub-label">${cheaper === 'craft' ? '<span class="check">✓</span>' : ''} craft from:</div>`;
      subRecipe.reagents.forEach(sr => {
        const sname = ITEMS[String(sr.itemId)]?.name || `Item #${sr.itemId}`;
        const sprice = getPrice(sr.itemId);
        html += `<div class="reagent">`;
        html += `<span class="r-qty">${sr.qty * r.qty}x</span>`;
        html += `<span class="r-rname">${sname}</span>`;
        html += sprice !== null
          ? `<span class="r-price has-price">${formatCopper(sprice)} ea</span>`
          : `<span class="r-price no-price">no data</span>`;
        html += `</div>`;
      });
      if (cheaper === 'buy') {
        html += `<div class="sub-label" style="color:#4ade80;"><span class="check">✓</span> buying is cheaper (${formatCopperCompact(buyCost)} vs ${formatCopperCompact(totalCraft)})</div>`;
      } else if (cheaper === 'craft' && buyCost !== null) {
        html += `<div class="sub-label">crafting saves ${formatCopperCompact(buyCost - totalCraft)}</div>`;
      }
      html += `</div>`;
    }
  });

  const craftCost = calcCraftCost(recipe);
  const sellPrice = recipe.resultId ? getPrice(recipe.resultId) : null;
  const profit = (craftCost !== null && sellPrice !== null) ? sellPrice - craftCost : null;

  html += `<div class="detail-footer">`;
  html += `<div class="footer-row"><span class="fl">Craft cost</span><span class="fv">${formatCopper(craftCost)}</span></div>`;
  html += `<div class="footer-row"><span class="fl">Sell price</span><span class="fv">${formatCopper(sellPrice)}</span></div>`;
  html += `<div class="footer-row"><span class="fl">Profit</span><span class="fv ${profit !== null ? (profit >= 0 ? 'pos' : 'neg') : ''}">${formatCopper(profit)}</span></div>`;
  html += `</div>`;
  return html;
}

document.addEventListener('DOMContentLoaded', () => {
  setupDropZone();
  init();

  const hint = document.getElementById('path-hint');
  const copyMsg = document.getElementById('copy-msg');
  hint.addEventListener('click', () => {
    const path = 'C:\\Games\\TurtleWoW\\WTF\\Account\\<ACCOUNT>\\SavedVariables\\aux-addon.lua';
    navigator.clipboard.writeText(path).then(() => {
      copyMsg.style.display = 'inline';
      setTimeout(() => { copyMsg.style.display = 'none'; }, 2000);
    });
  });
});
</script>
</body>
</html>
