<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TWoW Craft Calc</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: monospace; background: #12121f; color: #ccc; padding: 24px; }
  h1 { color: #a855f7; margin-bottom: 20px; font-size: 1.2em; letter-spacing: 0.05em; }

  /* Profession sections */
  .prof-section { max-width: 580px; margin-bottom: 28px; }
  .prof-header {
    color: #a855f7; font-size: 0.8em; font-weight: bold; letter-spacing: 0.12em;
    text-transform: uppercase; margin-bottom: 8px;
    border-bottom: 1px solid #2a2a40; padding-bottom: 6px;
  }
  .recipe-list { display: flex; flex-direction: column; gap: 2px; }

  /* Recipe accordion */
  .recipe-btn {
    background: #1c1c30; border: 1px solid #2a2a40; color: #ddd;
    padding: 10px 14px; text-align: left; cursor: pointer;
    font-family: monospace; font-size: 0.95em; width: 100%;
    display: flex; justify-content: space-between; align-items: center;
    transition: border-color 0.15s;
  }
  .recipe-btn::after { content: '▸'; color: #555; font-size: 0.8em; transition: transform 0.15s; }
  .recipe-btn.open::after { transform: rotate(90deg); }
  .recipe-btn:hover { border-color: #a855f7; color: #fff; }

  .recipe-detail {
    display: none; background: #161628; border: 1px solid #2a2a40;
    border-top: none; padding: 14px 16px;
  }
  .recipe-detail.open { display: block; }

  /* Component rows — grid: [qty] [name] [price] [stack-btn] */
  .component {
    display: grid;
    grid-template-columns: 36px 1fr auto 28px;
    align-items: center;
    gap: 6px;
    padding: 5px 0;
    border-bottom: 1px solid #1c1c30;
  }
  .component:last-child { border-bottom: none; }
  .comp-qty { color: #555; font-size: 0.9em; }
  .comp-name { color: #bbb; font-size: 0.9em; }

  /* Sub-components (crafted intermediate) */
  .sub-components {
    margin: 2px 0 4px 36px;
    border-left: 2px solid #2a2a40;
    padding-left: 10px;
  }
  .sub-label {
    font-size: 0.78em; color: #555; padding: 3px 0;
    display: flex; align-items: center; gap: 6px;
  }

  /* Buy vs craft checkmarks */
  .price-check { color: #4ade80; font-size: 0.85em; visibility: hidden; flex-shrink: 0; }
  .price-check.active { visibility: visible; }

  /* Price g/s/c inputs */
  .price-group { display: inline-flex; align-items: center; gap: 2px; }
  .price-group input {
    background: #0e0e1c; border: 1px solid #333; color: #fff;
    padding: 3px 4px; width: 38px; font-family: monospace; font-size: 0.85em;
    text-align: right; -moz-appearance: textfield; appearance: textfield;
    transition: border-color 0.15s;
  }
  .price-group input::-webkit-outer-spin-button,
  .price-group input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .price-group input:focus { border-color: #a855f7; outline: none; }
  .cur { font-size: 0.8em; }
  .cur-g { color: #fbbf24; }
  .cur-s { color: #94a3b8; }
  .cur-c { color: #92400e; }

  /* Stack popover — absolutely positioned, no layout shift */
  .stack-wrap { position: relative; display: inline-flex; align-items: center; }
  .stack-btn {
    background: none; border: 1px solid #2a2a40; color: #444; width: 22px; height: 22px;
    cursor: pointer; font-size: 0.7em; border-radius: 3px; line-height: 1;
    display: flex; align-items: center; justify-content: center;
    transition: border-color 0.15s, color 0.15s;
  }
  .stack-btn:hover, .stack-btn.open { border-color: #a855f7; color: #a855f7; }
  .stack-panel {
    display: none; position: absolute; top: calc(100% + 4px); right: 0; z-index: 50;
    background: #1c1c30; border: 1px solid #a855f7;
    padding: 10px; white-space: nowrap; min-width: 220px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  }
  .stack-panel.open { display: block; }
  .stack-panel label { font-size: 0.78em; color: #777; display: block; margin-bottom: 6px; }
  .stack-panel-row { display: flex; align-items: center; gap: 6px; }
  .stack-panel input.stack-size {
    width: 50px; background: #0e0e1c; border: 1px solid #333; color: #fff;
    padding: 3px 5px; font-family: monospace; font-size: 0.85em; text-align: right;
    -moz-appearance: textfield; appearance: textfield;
  }
  .stack-panel input.stack-size::-webkit-outer-spin-button,
  .stack-panel input.stack-size::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .stack-panel input.stack-size:focus { border-color: #a855f7; outline: none; }
  .stack-panel-at { color: #444; font-size: 0.85em; }

  /* Footer: cost / sell / profit */
  .recipe-footer { margin-top: 12px; padding-top: 10px; border-top: 1px solid #2a2a40; display: flex; flex-direction: column; gap: 6px; }
  .footer-row { display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
  .footer-label { color: #555; min-width: 80px; }
  .craft-cost, .profit-val { font-weight: bold; }
  .profit-val.pos { color: #4ade80; }
  .profit-val.neg { color: #f87171; }
</style>
</head>
<body>
<h1>TWoW Profession Auction Calc</h1>
<div id="app"></div>

<script>
let DATA = {};

async function init() {
  const res = await fetch('data.json');
  if (!res.ok) { console.error('Failed to load data.json:', res.status, res.url); return; }
  DATA = await res.json();
  if (!DATA.professions) { console.error('data.json missing professions key', DATA); return; }
  const app = document.getElementById('app');

  Object.entries(DATA.professions).forEach(([, prof]) => {
    const section = document.createElement('div');
    section.className = 'prof-section';
    section.innerHTML = `<div class="prof-header">${prof.name}</div>`;

    const list = document.createElement('div');
    list.className = 'recipe-list';

    prof.recipes.forEach(id => {
      const item = DATA.items[id];
      if (!item || !item.recipe) return;

      const btn = document.createElement('button');
      btn.className = 'recipe-btn';
      btn.textContent = item.name;

      const detail = document.createElement('div');
      detail.className = 'recipe-detail';
      detail.innerHTML = buildRecipeHTML(id);

      btn.onclick = () => {
        btn.classList.toggle('open');
        detail.classList.toggle('open');
      };

      list.appendChild(btn);
      list.appendChild(detail);

      detail.querySelectorAll('input').forEach(inp => {
        if (!inp.closest('.stack-panel')) {
          inp.addEventListener('input', () => recalc(detail, id));
        }
      });

      detail.querySelectorAll('.stack-btn').forEach(stackBtn => {
        stackBtn.addEventListener('click', e => {
          e.stopPropagation();
          const panel = stackBtn.nextElementSibling;
          const isOpen = panel.classList.contains('open');
          // close all other panels
          detail.querySelectorAll('.stack-panel.open').forEach(p => {
            p.classList.remove('open');
            p.previousElementSibling.classList.remove('open');
          });
          if (!isOpen) {
            panel.classList.add('open');
            stackBtn.classList.add('open');
          }
        });
      });

      detail.querySelectorAll('.stack-panel').forEach(panel => {
        const wrap = panel.closest('.stack-wrap');
        const priceGroup = wrap.closest('.component, .sub-components .component')
                               ?.querySelector('.price-group:not(.stack-price-group)')
          || wrap.parentElement.querySelector('.price-group:not(.stack-price-group)');
        const sizeInput = panel.querySelector('.stack-size');
        const stackPriceGroup = panel.querySelector('.stack-price-group');

        const calcPerItem = () => {
          const size = parseInt(sizeInput.value) || 0;
          const stackCopper = readCopper(stackPriceGroup);
          if (size > 0 && stackCopper) {
            const perItem = Math.floor(stackCopper / size);
            priceGroup.querySelector('.pg').value = Math.floor(perItem / 10000) || '';
            priceGroup.querySelector('.ps').value = Math.floor((perItem % 10000) / 100) || '';
            priceGroup.querySelector('.pc').value = perItem % 100 || '';
            recalc(detail, id);
          }
        };

        panel.querySelectorAll('input').forEach(inp => inp.addEventListener('input', calcPerItem));
      });
    });

    section.appendChild(list);
    app.appendChild(section);
  });

  // Close stack panels on outside click
  document.addEventListener('click', () => {
    document.querySelectorAll('.stack-panel.open').forEach(p => {
      p.classList.remove('open');
      p.previousElementSibling.classList.remove('open');
    });
  });
}

function priceGroupHTML(attrs, extraClass) {
  const cls = 'price-group' + (extraClass ? ' ' + extraClass : '');
  const attr = attrs ? ` ${attrs}` : '';
  return `<span class="${cls}"${attr}>`
    + `<input type="number" class="pg" min="0" placeholder="0"><span class="cur cur-g">g</span>`
    + `<input type="number" class="ps" min="0" max="99" placeholder="0"><span class="cur cur-s">s</span>`
    + `<input type="number" class="pc" min="0" max="99" placeholder="0"><span class="cur cur-c">c</span>`
    + `</span>`;
}

function stackWrapHTML(priceAttrs, extraClass) {
  return `<span class="stack-wrap">`
    + priceGroupHTML(priceAttrs, extraClass)
    + `<button type="button" class="stack-btn" title="Calculate from stack">÷</button>`
    + `<div class="stack-panel">`
    + `<label>Stack calculator</label>`
    + `<div class="stack-panel-row">`
    + `<input type="number" class="stack-size" min="1" placeholder="qty">`
    + `<span class="stack-panel-at">@</span>`
    + priceGroupHTML('', 'stack-price-group')
    + `</div></div></span>`;
}

function readCopper(group) {
  const pg = group.querySelector('.pg'), ps = group.querySelector('.ps'), pc = group.querySelector('.pc');
  if (!pg.value && !ps.value && !pc.value) return null;
  return (parseInt(pg.value) || 0) * 10000 + (parseInt(ps.value) || 0) * 100 + (parseInt(pc.value) || 0);
}

function formatCopper(val) {
  const neg = val < 0; val = Math.abs(val);
  const g = Math.floor(val / 10000), s = Math.floor((val % 10000) / 100), c = val % 100;
  return (neg ? '<span style="color:#f87171">-</span>' : '')
    + `<span class="cur-g">${g}g</span> <span class="cur-s">${s}s</span> <span class="cur-c">${c}c</span>`;
}

function buildRecipeHTML(itemId) {
  const item = DATA.items[itemId];
  if (!item.recipe) return '';
  let html = '';

  item.recipe.forEach(comp => {
    const ci = DATA.items[comp.item];
    html += `<div class="component-group" data-comp="${comp.item}" data-comp-qty="${comp.qty}">`;

    if (ci.recipe) {
      html += `<div class="component">`;
      html += `<span class="comp-qty">${comp.qty}x</span>`;
      html += `<span class="comp-name">${ci.name}</span>`;
      html += `<span style="display:inline-flex;align-items:center;gap:4px;">`
            + `<span class="price-check" data-check="buy">✓</span>`
            + stackWrapHTML(`data-item="${comp.item}" data-option="buy"`)
            + `</span>`;
      html += `<span></span>`; // grid placeholder for stack-btn column
      html += `</div>`;

      html += `<div class="sub-components" data-option="craft">`;
      html += `<div class="sub-label"><span class="price-check" data-check="craft">✓</span> craft from:</div>`;
      ci.recipe.forEach(sub => {
        const si = DATA.items[sub.item];
        html += `<div class="component">`;
        html += `<span class="comp-qty">${sub.qty * comp.qty}x</span>`;
        html += `<span class="comp-name">${si.name}</span>`;
        html += stackWrapHTML(`data-item="${sub.item}" data-parent="${comp.item}" data-base-qty="${sub.qty}"`);
        html += `</div>`;
      });
      html += `</div>`;
    } else {
      html += `<div class="component">`;
      html += `<span class="comp-qty">${comp.qty}x</span>`;
      html += `<span class="comp-name">${ci.name}</span>`;
      html += stackWrapHTML(`data-item="${comp.item}"`);
      html += `</div>`;
    }

    html += `</div>`;
  });

  html += `<div class="recipe-footer">`;
  html += `<div class="footer-row"><span class="footer-label">Craft cost</span><span class="craft-cost">—</span></div>`;
  html += `<div class="footer-row"><span class="footer-label">Sell price</span>${stackWrapHTML('', 'sell-price')}</div>`;
  html += `<div class="footer-row"><span class="footer-label">Profit</span><span class="profit-val">—</span></div>`;
  html += `</div>`;
  return html;
}

function recalc(detail, itemId) {
  const item = DATA.items[itemId];
  let total = 0, complete = true;

  item.recipe.forEach(comp => {
    const ci = DATA.items[comp.item];
    const grp = detail.querySelector(`.component-group[data-comp="${comp.item}"]`);

    if (ci.recipe) {
      const buyGrp = grp.querySelector(`.price-group[data-item="${comp.item}"][data-option="buy"]`);
      const buyCopper = buyGrp ? readCopper(buyGrp) : null;
      const buyCost = buyCopper !== null ? buyCopper * comp.qty : null;

      let craftCost = 0, craftComplete = true;
      ci.recipe.forEach(sub => {
        const sg = grp.querySelector(`.price-group[data-item="${sub.item}"]`);
        const copper = sg ? readCopper(sg) : null;
        if (copper !== null) craftCost += copper * sub.qty * comp.qty;
        else craftComplete = false;
      });

      const buyCheck = grp.querySelector('[data-check="buy"]');
      const craftCheck = grp.querySelector('[data-check="craft"]');
      buyCheck.classList.remove('active');
      craftCheck.classList.remove('active');

      if (buyCost !== null && craftComplete) {
        if (buyCost <= craftCost) { buyCheck.classList.add('active'); total += buyCost; }
        else { craftCheck.classList.add('active'); total += craftCost; }
      } else if (buyCost !== null) { buyCheck.classList.add('active'); total += buyCost; }
      else if (craftComplete) { craftCheck.classList.add('active'); total += craftCost; }
      else complete = false;
    } else {
      const sg = grp.querySelector(`.price-group[data-item="${comp.item}"]`);
      const copper = sg ? readCopper(sg) : null;
      if (copper !== null) total += copper * comp.qty;
      else complete = false;
    }
  });

  detail.querySelector('.craft-cost').innerHTML = complete ? formatCopper(total) : '—';

  const sellGrp = detail.querySelector('.price-group.sell-price');
  const profitEl = detail.querySelector('.profit-val');
  const sellCopper = sellGrp ? readCopper(sellGrp) : null;

  if (complete && sellCopper !== null) {
    const profit = sellCopper - total;
    profitEl.innerHTML = formatCopper(profit);
    profitEl.className = 'profit-val ' + (profit >= 0 ? 'pos' : 'neg');
  } else {
    profitEl.textContent = '—';
    profitEl.className = 'profit-val';
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
